# SOEC Hydrogen Production Train Topology
# 
# Process Description (REORDERED to match legacy architecture):
# 1. Hot wet H2 from SOEC (152°C) enters Heat Recovery (Interchanger).
# 2. Cooled gas passes through staged cooling and separation (DryCooler -> Chiller -> KODs).
# 3. Dried H2 is COMPRESSED (5-Stage to 40 bar) BEFORE purification.
# 4. Compressed H2 is purified (Deoxo -> PSA) at high pressure.
# 5. Recovered water is collected, mixed with fresh makeup water, pressurized, and pre-heated.

nodes:
  # =================================================================================
  # MAIN GAS TRAIN: SOEC -> SEPARATION -> COMPRESSION -> PURIFICATION
  # =================================================================================

  # 1. SOEC Cluster
  # -------------------------------------------------------------------------
  - id: "SOEC_Cluster"
    type: "SOEC"
    params:
      num_modules: 6
      max_power_nominal_mw: 2.4
      optimal_limit: 0.80
      steam_input_ratio_kg_per_kg_h2: 10.5
      power_first_step_mw: 0.12
      ramp_step_mw: 0.24
    connections:
      - source_port: "h2_out"
        target_name: "Cathode_Mixer"
        target_port: "inlet_1"
        resource_type: "stream"
      - source_port: "steam_out"
        target_name: "Cathode_Mixer"
        target_port: "inlet_2"
        resource_type: "stream"

  # -------------------------------------------------------------------------
  # 2. Cathode Mixer (Recombines H2 and Steam to simulate Exhaust)
  # -------------------------------------------------------------------------
  - id: "Cathode_Mixer"
    type: "Mixer"
    params:
      volume_m3: 5.0
      continuous_flow: true
    connections:
      - source_port: "outlet"
        target_name: "Interchanger_1"
        target_port: "hot_in"
        resource_type: "stream"

  # 3. Heat Recovery (Interchanger)
  - id: "Interchanger_1"
    type: "Interchanger"
    params:
      min_approach_temp_k: 10.0
      target_cold_out_temp_c: 95.0
    connections:
      - source_port: "hot_out"
        target_name: "DryCooler_HX"  # Changed: Now goes to DryCooler first
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "cold_out"
        target_name: "Steam_Generator"
        target_port: "water_in"
        resource_type: "stream"

  # 3b. Dry Cooler (Post-Heat Recovery) - Matches legacy "Dry Cooler 1"
  # Cools gas to 90°C to ensure proper condensation before KOD_1
  - id: "DryCooler_HX"
    type: "DryCooler"
    params:
      target_temp_c: 90.0  # Legacy target: T_DRY_COOLER_OUT_H2_C = 90°C
    connections:
      - source_port: "fluid_out"
        target_name: "KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"

  # =================================================================================
  # SEPARATION STAGE (Before Compression)
  # =================================================================================

  - id: "KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.8
      delta_p_bar: 0.05
    connections:
      - source_port: "gas_outlet"
        target_name: "Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "Drain_Mixer"
        target_port: "KOD_1"
        resource_type: "stream"

  - id: "Chiller_1"
    type: "Chiller"
    params:
      target_temp_k: 277.15 # 4°C
      cooling_capacity_kw: 200.0
    connections:
      - source_port: "fluid_out"
        target_name: "KOD_2"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.6
      delta_p_bar: 0.05
    connections:
      - source_port: "gas_outlet"
        target_name: "Compressor_S1"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "Drain_Mixer"
        target_port: "KOD_2"
        resource_type: "stream"



  # =================================================================================
  # COMPRESSION TRAIN (6-Stage, BEFORE Purification)
  # Redistributed Pressure Ratios ~2.0x per stage (Target ~42 bar)
  # =================================================================================

  - id: "Compressor_S1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_1"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "Compressor_S2"
        target_port: "h2_in"
        resource_type: "stream"
  
  - id: "Compressor_S2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_2"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "Compressor_S3"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "Compressor_S3"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_3"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_3"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "Compressor_S4"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "Compressor_S4"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_4"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_4"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "Compressor_S5"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "Compressor_S5"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_5"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_5"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "Compressor_S6"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "Compressor_S6"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 40.0
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_6"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_6"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "Deoxo_1"
        target_port: "inlet"
        resource_type: "stream"



  # =================================================================================
  # PURIFICATION STAGE (After 6-Stage Compression, at 42 bar)
  # =================================================================================

  - id: "Deoxo_1"
    type: "DeoxoReactor"
    params: {}
    connections:
      - source_port: "outlet"
        target_name: "Chiller_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Chiller_2"
    type: "Chiller"
    params:
      target_temp_k: 277.15 # 4°C heavy cooling for condensation
    connections:
      - source_port: "fluid_out"
        target_name: "Coalescer_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "Coalescer_2"
    type: "Coalescer"
    params:
      d_shell: 0.3  # Post-Deoxo coalescer (high pressure, low liquid load)
    connections:
      - source_port: "outlet"
        target_name: "ElectricBoiler_PSA"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "Coalescer_2"
        resource_type: "stream"

  - id: "ElectricBoiler_PSA"
    type: "ElectricBoiler"
    params:
      max_power_kw: 50.0
      target_temp_c: 40.0 
    connections:
      - source_port: "fluid_out"
        target_name: "PSA_1"
        target_port: "gas_in"
        resource_type: "stream"

  - id: "PSA_1"
    type: "PSA Unit"
    params:
      purity_target: 0.99995
    connections: []  # Final product outlet

  # =================================================================================
  # WATER RECIRCULATION LOOP
  # =================================================================================

  - id: "Drain_Mixer"
    type: "DrainRecorderMixer"
    params:
      source_ids: ["KOD_1", "KOD_2", "Coalescer_2"]
    connections:
      - source_port: "outlet"
        target_name: "Makeup_Mixer_1"
        target_port: "drain_in"
        resource_type: "stream"
  
  - id: "Makeup_Mixer_1"
    type: "MakeupMixer"
    params:
      target_flow_kg_h: 3600.0
    connections:
      - source_port: "water_out"
        target_name: "Feed_Pump"
        target_port: "water_in"
        resource_type: "stream"

  - id: "Feed_Pump"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "Feed_Pump"
      capacity_kg_h: 3600.0
      target_pressure_pa: 500000.0 # 5 bar
    connections:
      - source_port: "water_out"
        target_name: "Interchanger_1" # To Cold Side of HX
        target_port: "cold_in"
        resource_type: "stream"

  # Final Step: Steam Generator
  - id: "Steam_Generator"
    type: "ElectricBoiler"
    params:
      max_power_kw: 3000.0
      target_temp_c: 152.0 # Steam Temp
    connections: 
      - source_port: "fluid_out"
        target_name: "SOEC_Cluster"
        target_port: "steam_in"
        resource_type: "stream"
