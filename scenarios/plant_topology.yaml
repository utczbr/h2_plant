# SOEC Hydrogen Production Train Topology
# 
# Process Description (REORDERED to match legacy architecture):
# 1. Hot wet H2 from SOEC (152°C) enters Heat Recovery (Interchanger).
# 2. Cooled gas passes through staged cooling and separation (DryCooler -> Chiller -> KODs).
# 3. Dried H2 is COMPRESSED (5-Stage to 40 bar) BEFORE purification.
# 4. Compressed H2 is purified (Deoxo -> PSA) at high pressure.
# 5. Recovered water is collected, mixed with fresh makeup water, pressurized, and pre-heated.

nodes:
  # =================================================================================
  # MAIN GAS TRAIN: SOEC -> SEPARATION -> COMPRESSION -> PURIFICATION
  # =================================================================================

  # 1. SOEC Cluster
  # -------------------------------------------------------------------------
  # The h2_out port now outputs the combined Cathode Exhaust (Wet Hydrogen):
  # H2 (produced) + H2O (unreacted steam) + trace O2 (crossover)
  - id: "SOEC_Cluster"
    type: "SOEC"
    params:
      num_modules: 6
      max_power_nominal_mw: 2.4
      optimal_limit: 0.80
      steam_input_ratio_kg_per_kg_h2: 11.0 
      power_first_step_mw: 0.12
      ramp_step_mw: 0.24
      process_step: 10
    connections:
      - source_port: "h2_out"
        target_name: "Interchanger_1"
        target_port: "hot_in"
        resource_type: "stream"
      - source_port: "o2_out"
        target_name: "O2_DryCooler"
        target_port: "fluid_in"
        resource_type: "stream"

  # 2. Heat Recovery (Interchanger)
  - id: "Interchanger_1"
    type: "Interchanger"
    params:
      min_approach_temp_k: 10.0
      target_cold_out_temp_c: 95.0
      process_step: 20
    connections:
      - source_port: "hot_out"
        target_name: "DryCooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "cold_out"
        target_name: "Steam_Generator"
        target_port: "water_in"
        resource_type: "stream"


  # 3b. Dry Cooler (Post-Heat Recovery)
  - id: "DryCooler_1"
    type: "DryCooler"
    params:
      target_temp_c: 40.0  
      process_step: 30
    connections:
      - source_port: "fluid_out"
        target_name: "KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"

  # =================================================================================
  # SEPARATION STAGE (Before Compression)
  # =================================================================================

  - id: "KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.8
      delta_p_bar: 0.05
      process_step: 40
    connections:
      - source_port: "gas_outlet"
        target_name: "Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "Drain_Mixer"
        target_port: "KOD_1"
        resource_type: "stream"

  - id: "Chiller_1"
    type: "Chiller"
    params:
      component_id: "Chiller_1"  # ID Explicitly set
      cooling_capacity_kw: 500.0
      target_temp_k: 277.15 # 4°C
      process_step: 33  # Reordered step
    connections:
      - source_port: "fluid_out"
        target_name: "KOD_2"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.6
      delta_p_bar: 0.05
      process_step: 60
    connections:
      - source_port: "gas_outlet"
        target_name: "Cyclone_1"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "Drain_Mixer"
        target_port: "KOD_2"
        resource_type: "stream"

  - id: "Cyclone_1"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0  # High efficiency separation of fine mist
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0   # Optimized for fine droplets
      process_step: 70
    connections:
      - source_port: "outlet"
        target_name: "Compressor_S1"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "Cyclone_1"
        resource_type: "stream"



  # =================================================================================
  # COMPRESSION TRAIN (6-Stage, BEFORE Purification)
  # Redistributed Pressure Ratios ~2.0x per stage (Target ~42 bar)
  # =================================================================================

  - id: "Compressor_S1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 100
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_1"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 101
    connections:
      - source_port: "fluid_out"
        target_name: "Compressor_S2"
        target_port: "h2_in"
        resource_type: "stream"
  
  - id: "Compressor_S2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 110
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_2"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 111
    connections:
      - source_port: "fluid_out"
        target_name: "Cyclone_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "Cyclone_2"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 112
    connections:
      - source_port: "outlet"
        target_name: "Compressor_S3"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "Cyclone_2"
        resource_type: "stream"

  - id: "Compressor_S3"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 120
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_3"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_3"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 121
    connections:
      - source_port: "fluid_out"
        target_name: "Cyclone_3"
        target_port: "inlet"
        resource_type: "stream"

  - id: "Cyclone_3"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 122
    connections:
      - source_port: "outlet"
        target_name: "Compressor_S4"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "Cyclone_3"
        resource_type: "stream"

  - id: "Compressor_S4"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 130
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_4"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_4"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 131
    connections:
      - source_port: "fluid_out"
        target_name: "Cyclone_4"
        target_port: "inlet"
        resource_type: "stream"

  - id: "Cyclone_4"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 132
    connections:
      - source_port: "outlet"
        target_name: "Compressor_S5"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "Cyclone_4"
        resource_type: "stream"

  - id: "Compressor_S5"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 140
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_5"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_5"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 141
    connections:
      - source_port: "fluid_out"
        target_name: "Cyclone_5"
        target_port: "inlet"
        resource_type: "stream"

  - id: "Cyclone_5"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 142
    connections:
      - source_port: "outlet"
        target_name: "Compressor_S6"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "Cyclone_5"
        resource_type: "stream"

  - id: "Compressor_S6"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 41.0
      process_step: 150
    connections:
      - source_port: "outlet"
        target_name: "Intercooler_6"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Intercooler_6"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 151
    connections:
      - source_port: "fluid_out"
        target_name: "Deoxo_1"
        target_port: "inlet"
        resource_type: "stream"



  # =================================================================================
  # PURIFICATION STAGE (After 6-Stage Compression, at 42 bar)
  # =================================================================================

  - id: "Deoxo_1"
    type: "DeoxoReactor"
    params:
      process_step: 200
    connections:
      - source_port: "outlet"
        target_name: "Chiller_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "Chiller_2"
    type: "Chiller"
    params:
      target_temp_k: 277.15 # 4°C heavy cooling for condensation
      cooling_capacity_kw: 300.0
      process_step: 210
    connections:
      - source_port: "fluid_out"
        target_name: "Coalescer_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "Coalescer_2"
    type: "Coalescer"
    params:
      d_shell: 0.3  # Post-Deoxo coalescer (high pressure, low liquid load)
      process_step: 220
    connections:
      - source_port: "outlet"
        target_name: "ElectricBoiler_PSA"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "Coalescer_2"
        resource_type: "stream"

  - id: "ElectricBoiler_PSA"
    type: "ElectricBoiler"
    params:
      max_power_kw: 50.0
      target_temp_c: 40.0 
      process_step: 230
    connections:
      - source_port: "fluid_out"
        target_name: "PSA_1"
        target_port: "gas_in"
        resource_type: "stream"

  - id: "PSA_1"
    type: "PSA Unit"
    params:
      purity_target: 0.99995
      process_step: 300
    connections:
      - source_port: "purified_gas_out"
        target_name: "H2_Production_Mixer"
        target_port: "inlet_1"
        resource_type: "gas"

  # =================================================================================
  # O2 PURIFICATION TRAIN (Anode Side)
  # Sequence: SOEC(o2_out) -> KOD1 -> DryCooler -> Chiller -> KOD2 -> Coalescer -> Vent
  # =================================================================================



  # === 2. O2_DryCooler (DryCooler) ===
  # "Initial air-cooled cooling"
  - id: "O2_DryCooler"
    type: "DryCooler"
    params:
      component_id: "O2_DryCooler"
      process_step: 20
    connections:
      - source_port: "fluid_out"
        target_name: "O2_Chiller"
        target_port: "fluid_in"
        resource_type: "stream"

  # === 3. O2_Chiller (Chiller) ===
  # "Deep cooling/condensation to ~4°C"
  - id: "O2_Chiller"
    type: "Chiller"
    params:
      target_temp_k: 277.15  # 4°C
      cooling_capacity_kw: 200.0 # Increased for O2 flow
      cop: 4.0
      pressure_drop_bar: 0.2
      process_step: 30
    connections:
      - source_port: "fluid_out"
        target_name: "O2_KOD_2"
        target_port: "gas_inlet"
        resource_type: "stream"

  # === 4. O2_KOD_2 (KnockOutDrum) ===
  # "Post-chill water knockout"
  - id: "O2_KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "O2"
      process_step: 40
    connections:
      - source_port: "gas_outlet"
        target_name: "O2_Coalescer"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "Drain_Mixer"
        target_port: "O2_KOD_2"
        resource_type: "stream"

  # === 5. O2_Coalescer (Coalescer) ===
  # "Final mist eliminator"
  - id: "O2_Coalescer"
    type: "Coalescer"
    params:
      component_id: "O2_Coalescer"
      gas_type: "O2"
      process_step: 50
    connections:
      - source_port: "outlet"
        target_name: "O2_Vent_Valve"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "Drain_Mixer"
        target_port: "O2_Coalescer"
        resource_type: "stream"

  # === 6. O2_Vent_Valve (Valve) ===
  - id: "O2_Vent_Valve"
    type: "Valve"
    params:
      P_out_pa: 101325.0   # Vent to atmosphere
      fluid: "O2"
    connections: []

  # =================================================================================
  # WATER RECIRCULATION LOOP
  # =================================================================================

  - id: "Drain_Mixer"
    type: "DrainRecorderMixer"
    params:
      source_ids: ["KOD_1", "KOD_2", "Cyclone_1", "Cyclone_2", "Cyclone_3", "Cyclone_4", "Cyclone_5", "Coalescer_2", "O2_KOD_2", "O2_Coalescer"]
    connections:
      - source_port: "outlet"
        target_name: "Makeup_Mixer_1"
        target_port: "drain_in"
        resource_type: "stream"
  
  - id: "Makeup_Mixer_1"
    type: "MakeupMixer"
    params:
      target_flow_kg_h: 3600.0
    connections:
      - source_port: "water_out"
        target_name: "Feed_Pump"
        target_port: "water_in"
        resource_type: "stream"

  - id: "Feed_Pump"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "Feed_Pump"
      capacity_kg_h: 3600.0
      target_pressure_pa: 500000.0 # 5 bar
    connections:
      - source_port: "water_out"
        target_name: "Interchanger_1" # To Cold Side of HX
        target_port: "cold_in"
        resource_type: "stream"

  # Final Step: Steam Generator
  - id: "Steam_Generator"
    type: "ElectricBoiler"
    params:
      max_power_kw: 3000.0
      target_temp_c: 152.0 # Steam Temp
    connections: 
      - source_port: "fluid_out"
        target_name: "SOEC_Cluster"
        target_port: "steam_in"
        resource_type: "stream"

  # =================================================================================
  # PEM HYDROGEN PRODUCTION TRAIN (Secondary Source)
  # =================================================================================

  - id: "PEM_Electrolyzer"
    type: "PEM"
    params:
      max_power_mw: 5.0
      use_polynomials: True
      water_excess_factor: 0.02 
      out_pressure_pa: 4000000.0 # 40 bar 
    connections:
      - source_port: "h2_out"
        target_name: "PEM_KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "PEM_KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "H2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_DryCooler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_DryCooler_1"
    type: "DryCooler"
    params: {}
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_Chiller_1"
    type: "Chiller"
    params:
      target_temp_k: 277.15
      cooling_capacity_kw: 100.0
      cop: 4.0
      pressure_drop_bar: 0.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_KOD_2"
        target_port: "gas_inlet"
        resource_type: "gas"

  - id: "PEM_KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "H2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_Coalescer_1"
        target_port: "inlet"
        resource_type: "gas_mixture"

  - id: "PEM_Coalescer_1"
    type: "Coalescer"
    params:
      gas_type: "H2"
    connections:
      - source_port: "outlet"
        target_name: "PEM_ElectricBoiler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_ElectricBoiler_1"
    type: "ElectricBoiler"
    params: 
      max_power_kw: 25.0
      target_temp_c: 40.0
      efficiency: 0.98
    connections:
      - source_port: "fluid_out"  
        target_name: "PEM_Deoxo_1"
        target_port: "inlet"
        resource_type: "gas"

  - id: "PEM_Deoxo_1"
    type: "DeoxoReactor"
    params: {}
    connections:
      - source_port: "outlet"
        target_name: "PEM_Chiller_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_Chiller_2"
    type: "Chiller"
    params:
      target_temp_k: 277.15
      cooling_capacity_kw: 100.0
      cop: 4.0
      pressure_drop_bar: 0.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_KOD_3"
        target_port: "gas_inlet"
        resource_type: "gas"
    
  - id: "PEM_KOD_3"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "H2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_ElectricBoiler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_ElectricBoiler_2"
    type: "ElectricBoiler"
    params: 
      max_power_kw: 25.0
      target_temp_c: 30.0
      efficiency: 0.98
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_PSA_1"
        target_port: "gas_in"
        resource_type: "stream"

  - id: "PEM_PSA_1"
    type: "PSA Unit"
    params:
      purity_target: 0.9999
      recovery_rate: 0.90
      power_consumption_kw: 10.0
    connections: 
      - source_port: "purified_gas_out"
        target_name: "H2_Production_Mixer"
        target_port: "inlet_2"
        resource_type: "gas"

  # =================================================================================
  # H2 PRODUCTION MIXING (Combines SOEC and PEM Trains)
  # =================================================================================

  - id: "H2_Production_Mixer"
    type: "Mixer"
    params:
      volume_m3: 5.0
      continuous_flow: true
      process_step: 400
    connections:
      - source_port: "outlet"
        target_name: "HP_Compressor_S1"
        target_port: "h2_in"
        resource_type: "gas"

  # =================================================================================
  # HIGH PRESSURE COMPRESSION TRAIN (40 bar → 500 bar)
  # Redistributed Pressure Ratios ~1.65x per stage
  # Limit: 135ºC
  # =================================================================================

  # --- Stage 1 (40.0 → 66.3 bar) ---
  - id: "HP_Compressor_S1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0 # Pro-rated for combined flow (400 SOEC + 120 PEM approx)
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 40.0
      outlet_pressure_bar: 66.3
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S1"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S2"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 2 (66.3 → 109.9 bar) ---
  - id: "HP_Compressor_S2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 66.3
      outlet_pressure_bar: 109.9
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S2"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S3"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 3 (109.9 → 182.1 bar) ---
  - id: "HP_Compressor_S3"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 109.9
      outlet_pressure_bar: 182.1
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S3"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S3"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S4"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 4 (182.1 → 301.8 bar) ---
  - id: "HP_Compressor_S4"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 182.1
      outlet_pressure_bar: 301.8
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S4"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S4"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S5"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 5 (301.8 → 500.0 bar) ---
  - id: "HP_Compressor_S5"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 301.8
      outlet_pressure_bar: 500.0
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S5"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S5"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "H2_Storage_Tank"
        target_port: "h2_in"
        resource_type: "gas"

  # =================================================================================
  # HYDROGEN STORAGE (500 bar)
  # =================================================================================

  - id: "H2_Storage_Tank"
    type: "Tank"
    params:
      n_tanks: 10
      capacity_kg: 1000.0  # 10000 kg total (10 ton)
      max_pressure_bar: 500.0
      temperature_k: 298.15
    connections: []
