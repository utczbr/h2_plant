# SOEC Hydrogen Production Train Topology
# 
# Process Description (REORDERED to match legacy architecture):
# 1. Hot wet H2 from SOEC (152°C) enters Heat Recovery (Interchanger).
# 2. Cooled gas passes through staged cooling and separation (DryCooler -> Chiller -> KODs).
# 3. Dried H2 is COMPRESSED (5-Stage to 40 bar) BEFORE purification.
# 4. Compressed H2 is purified (Deoxo -> PSA) at high pressure.
# 5. Recovered water is collected, mixed with fresh makeup water, pressurized, and pre-heated.

nodes:
  # =================================================================================
  # MAIN GAS TRAIN: SOEC -> SEPARATION -> COMPRESSION -> PURIFICATION
  # =================================================================================

  # 1. SOEC Cluster
  # -------------------------------------------------------------------------
  # The h2_out port now outputs the combined Cathode Exhaust (Wet Hydrogen):
  # H2 (produced) + H2O (unreacted steam) + trace O2 (crossover)
  - id: "SOEC_Cluster"
    type: "SOEC"
    params:
      num_modules: 6
      max_power_nominal_mw: 2.4
      optimal_limit: 0.80
      steam_input_ratio_kg_per_kg_h2: 11.0 
      power_first_step_mw: 0.12
      ramp_step_mw: 0.24
      process_step: 10
    connections:
      - source_port: "h2_out"
        target_name: "SOEC_H2_Interchanger_1"
        target_port: "hot_in"
        resource_type: "stream"
      - source_port: "o2_out"
        target_name: "SOEC_O2_Drycooler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  # 2. Heat Recovery (Interchanger)
  - id: "SOEC_H2_Interchanger_1"
    type: "Interchanger"
    params:
      min_approach_temp_k: 10.0
      target_cold_out_temp_c: 95.0
      process_step: 20
    connections:
      - source_port: "hot_out"
        target_name: "SOEC_H2_DryCooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "cold_out"
        target_name: "SOEC_Steam_Generator"
        target_port: "fluid_in"
        resource_type: "stream"


  # 3b. Dry Cooler (Post-Heat Recovery)
  - id: "SOEC_H2_DryCooler_1"
    type: "DryCooler"
    params:
      target_temp_c: 40.0  
      process_step: 30
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"

  # =================================================================================
  # SEPARATION STAGE (Before Compression)
  # =================================================================================

  - id: "SOEC_H2_KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.8
      delta_p_bar: 0.05
      process_step: 40
    connections:
      - source_port: "gas_outlet"
        target_name: "SOEC_H2_Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_KOD_1"
        resource_type: "stream"

  - id: "SOEC_H2_Chiller_1"
    type: "Chiller"
    params:
      cooling_capacity_kw: 500.0
      target_temp_k: 277.15 # 4°C
      process_step: 33  # Reordered step
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_KOD_2"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "SOEC_H2_KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.6
      delta_p_bar: 0.05
      process_step: 60
    connections:
      - source_port: "gas_outlet"
        target_name: "SOEC_H2_Cyclone_1"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_KOD_2"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_1"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0  # High efficiency separation of fine mist
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0   # Optimized for fine droplets
      process_step: 70
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S1"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_Cyclone_1"
        resource_type: "stream"



  # =================================================================================
  # COMPRESSION TRAIN (6-Stage, BEFORE Purification)
  # Redistributed Pressure Ratios ~2.0x per stage (Target ~42 bar)
  # =================================================================================

  - id: "SOEC_H2_Compressor_S1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 100
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_1"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 101
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Compressor_S2"
        target_port: "h2_in"
        resource_type: "stream"
  
  - id: "SOEC_H2_Compressor_S2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 110
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_2"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 111
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_2"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 112
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S3"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_Cyclone_2"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S3"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 120
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_3"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_3"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 121
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_3"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_3"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 122
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S4"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_Cyclone_3"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S4"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 130
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_4"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_4"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 131
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_4"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_4"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 132
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S5"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_Cyclone_4"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S5"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 140
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_5"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_5"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 141
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_5"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_5"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 142
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S6"
        target_port: "h2_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_Cyclone_5"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S6"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 41.0
      process_step: 150
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_6"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_6"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 151
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Deoxo_1"
        target_port: "inlet"
        resource_type: "stream"



  # =================================================================================
  # PURIFICATION STAGE (After 6-Stage Compression, at 42 bar)
  # =================================================================================

  - id: "SOEC_H2_Deoxo_1"
    type: "DeoxoReactor"
    params:
      process_step: 200
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Chiller_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Chiller_2"
    type: "Chiller"
    params:
      target_temp_k: 277.15 # 4°C heavy cooling for condensation
      cooling_capacity_kw: 300.0
      process_step: 210
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Coalescer_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Coalescer_2"
    type: "Coalescer"
    params:
      d_shell: 0.3  # Post-Deoxo coalescer (high pressure, low liquid load)
      process_step: 220
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_ElectricBoiler_PSA"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_H2_Coalescer_2"
        resource_type: "stream"

  - id: "SOEC_H2_ElectricBoiler_PSA"
    type: "ElectricBoiler"
    params:
      max_power_kw: 50.0
      target_temp_c: 40.0 
      process_step: 230
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_PSA_1"
        target_port: "gas_in"
        resource_type: "stream"

  - id: "SOEC_H2_PSA_1"
    type: "PSA Unit"
    params:
      purity_target: 0.99995
      process_step: 300
    connections:
      - source_port: "purified_gas_out"
        target_name: "H2_Production_Mixer"
        target_port: "inlet_1"
        resource_type: "gas"

  # =================================================================================
  # O2 PURIFICATION TRAIN (Anode Side)
  # Sequence: SOEC(o2_out) -> KOD1 -> DryCooler -> Chiller -> KOD2 -> Coalescer -> Vent
  # =================================================================================



  # === New O2 Compression Train (4 Stages) ===
  
  # Stage 1
  - id: "SOEC_O2_Drycooler_1"
    type: "DryCooler"
    params:
      component_id: "SOEC_O2_Drycooler_1"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_1"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_1"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_O2_Drycooler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  # Stage 2
  - id: "SOEC_O2_Drycooler_2"
    type: "DryCooler"
    params: 
      component_id: "SOEC_O2_Drycooler_2"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_2"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_O2_Drycooler_3"
        target_port: "fluid_in"
        resource_type: "stream"

  # Stage 3
  - id: "SOEC_O2_Drycooler_3"
    type: "DryCooler"
    params:
      component_id: "SOEC_O2_Drycooler_3"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_3"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_3"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_O2_Drycooler_4"
        target_port: "fluid_in"
        resource_type: "stream"

  # Stage 4
  - id: "SOEC_O2_Drycooler_4"
    type: "DryCooler"
    params:
      component_id: "SOEC_O2_Drycooler_4"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_4"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_4"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_O2_Drycooler_5"
        target_port: "fluid_in"
        resource_type: "stream"

  # Stage 5
  - id: "SOEC_O2_Drycooler_5"
    type: "DryCooler"
    params:
      component_id: "SOEC_O2_Drycooler_5"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_5"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_5"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections: []


  # =================================================================================
  # WATER RECIRCULATION LOOP
  # =================================================================================

  - id: "SOEC_Drain_Mixer"
    type: "DrainRecorderMixer"
    params:
      source_ids: ["SOEC_H2_KOD_1", "SOEC_H2_KOD_2", "SOEC_H2_Cyclone_1", "SOEC_H2_Cyclone_2", "SOEC_H2_Cyclone_3", "SOEC_H2_Cyclone_4", "SOEC_H2_Cyclone_5", "SOEC_H2_Coalescer_2"]
    connections:
      - source_port: "outlet"
        target_name: "SOEC_Makeup_Mixer"
        target_port: "drain_in"
        resource_type: "stream"
  
  - id: "SOEC_Makeup_Mixer"
    type: "MakeupMixer"
    params:
      target_flow_kg_h: 3600.0  # SOEC theoretical demand
    connections:
      - source_port: "water_out"
        target_name: "SOEC_Feed_Pump"
        target_port: "water_in"
        resource_type: "stream"
  
  # Water Balance Tracker: Calculates stoichiometric water consumption from H2 production
  - id: "Water_Balance_Tracker"
    type: "WaterBalanceTracker"
    params: {}
    connections:
      - source_port: "consumption_out"
        target_name: "SOEC_Makeup_Mixer"
        target_port: "consumption_in"
        resource_type: "signal"

  - id: "SOEC_Feed_Pump"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "SOEC_Feed_Pump"
      capacity_kg_h: 3600.0
      target_pressure_pa: 500000.0 # 5 bar
    connections:
      - source_port: "water_out"
        target_name: "SOEC_H2_Interchanger_1" # To Cold Side of HX
        target_port: "cold_in"
        resource_type: "stream"

  # Final Step: Steam Generator
  - id: "SOEC_Steam_Generator"
    type: "ElectricBoiler"
    params:
      max_power_kw: 3000.0
      target_temp_c: 152.0 # Steam Temp
    connections: 
      - source_port: "fluid_out"
        target_name: "SOEC_Cluster"
        target_port: "steam_in"
        resource_type: "stream"

  # =================================================================================
  # PEM WATER RECIRCULATION LOOP
  # =================================================================================

  - id: "PEM_Drain_Mixer"
    type: "DrainRecorderMixer"
    params:
      source_ids: ["PEM_H2_KOD_1", "PEM_H2_KOD_2", "PEM_H2_KOD_3", "PEM_H2_Coalescer_1", "PEM_O2_KOD_1", "PEM_O2_KOD_2", "PEM_O2_Coalescer_1"]
    connections:
      - source_port: "outlet"
        target_name: "PEM_Water_Return_Valve"
        target_port: "inlet"
        resource_type: "stream"

  - id: "PEM_Water_Return_Valve"
    type: "Valve"
    params:
      component_id: "PEM_Water_Return_Valve"
      P_out_pa: 100000.0 # 1 bar
      fluid: "H2O"
    connections: 
      - source_port: "outlet"
        target_name: "PEM_Makeup_Mixer"
        target_port: "drain_in"
        resource_type: "stream"

  - id: "PEM_Makeup_Mixer"
    type: "MakeupMixer"
    params:
      target_flow_kg_h: 4000.0  # PEM theoretical demand (~5 MW)
    connections:
      - source_port: "water_out"
        target_name: "PEM_Water_Pump"
        target_port: "water_in"
        resource_type: "stream"

  - id: "PEM_Water_Pump"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "PEM_Water_Pump"
      capacity_kg_h: 4000.0
      target_pressure_pa: 4000000.0  # 40 bar (PEM operating pressure)
    connections:
      - source_port: "water_out"
        target_name: "PEM_Electrolyzer"
        target_port: "water_in"
        resource_type: "stream"

  # =================================================================================
  # PEM HYDROGEN PRODUCTION TRAIN (Secondary Source)
  # =================================================================================

  - id: "PEM_Electrolyzer"
    type: "PEM"
    params:
      max_power_mw: 5.0
      use_polynomials: True
      water_excess_factor: 0.02 
      out_pressure_pa: 4000000.0 # 40 bar 
    connections:
      - source_port: "h2_out"
        target_name: "PEM_H2_KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"
      - source_port: "oxygen_out"
        target_name: "PEM_O2_KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "PEM_H2_KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "H2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_H2_DryCooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "PEM_Drain_Mixer"
        target_port: "PEM_H2_KOD_1"
        resource_type: "stream"

  - id: "PEM_H2_DryCooler_1"
    type: "DryCooler"
    params: {}
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_H2_Chiller_1"
    type: "Chiller"
    params:
      target_temp_k: 277.15
      cooling_capacity_kw: 500.0 # Upsized for 5x liquid water
      cop: 4.0
      pressure_drop_bar: 0.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_KOD_2"
        target_port: "gas_inlet"
        resource_type: "gas"

  - id: "PEM_H2_KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "H2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_H2_Coalescer_1"
        target_port: "inlet"
        resource_type: "gas_mixture"
      - source_port: "liquid_drain"
        target_name: "PEM_Drain_Mixer"
        target_port: "PEM_H2_KOD_2"
        resource_type: "stream"

  - id: "PEM_H2_Coalescer_1"
    type: "Coalescer"
    params:
      gas_type: "H2"
    connections:
      - source_port: "outlet"
        target_name: "PEM_H2_ElectricBoiler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "PEM_Drain_Mixer"
        target_port: "PEM_H2_Coalescer_1"
        resource_type: "stream"

  - id: "PEM_H2_ElectricBoiler_1"
    type: "ElectricBoiler"
    params: 
      max_power_kw: 25.0
      target_temp_c: 40.0
      efficiency: 0.98
    connections:
      - source_port: "fluid_out"  
        target_name: "PEM_H2_Deoxo_1"
        target_port: "inlet"
        resource_type: "gas"

  - id: "PEM_H2_Deoxo_1"
    type: "DeoxoReactor"
    params: {}
    connections:
      - source_port: "outlet"
        target_name: "PEM_H2_Chiller_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_H2_Chiller_2"
    type: "Chiller"
    params:
      target_temp_k: 277.15
      cooling_capacity_kw: 500.0 # Upsized for 5x liquid water
      cop: 4.0
      pressure_drop_bar: 0.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_KOD_3"
        target_port: "gas_inlet"
        resource_type: "gas"
    
  - id: "PEM_H2_KOD_3"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "H2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_H2_ElectricBoiler_2"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "PEM_Drain_Mixer"
        target_port: "PEM_H2_KOD_3"
        resource_type: "stream"
        resource_type: "stream"

  - id: "PEM_H2_ElectricBoiler_2"
    type: "ElectricBoiler"
    params: 
      max_power_kw: 25.0
      target_temp_c: 30.0
      efficiency: 0.98
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_PSA_1"
        target_port: "gas_in"
        resource_type: "stream"

  - id: "PEM_H2_PSA_1"
    type: "PSA Unit"
    params:
      purity_target: 0.9999
      recovery_rate: 0.90
      power_consumption_kw: 10.0
    connections: 
      - source_port: "purified_gas_out"
        target_name: "H2_Production_Mixer"
        target_port: "inlet_2"
        resource_type: "gas"

  # =================================================================================
  # PEM O2 PURIFICATION TRAIN
  # Sequence: PEM(o2_out) -> KOD1 -> DryCooler -> Chiller -> KOD2 -> Coalescer -> Valve -> Vent
  # =================================================================================

  - id: "PEM_O2_KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "O2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_O2_Drycooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "PEM_Drain_Mixer"
        target_port: "PEM_O2_KOD_1"
        resource_type: "stream"

  - id: "PEM_O2_Drycooler_1"
    type: "DryCooler"
    params:
      component_id: "PEM_O2_Drycooler_1"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_O2_Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_O2_Chiller_1"
    type: "Chiller"
    params:
      component_id: "PEM_O2_Chiller_1"
      target_temp_k: 277.15 # 4°C
      cooling_capacity_kw: 8000.0 # Upsized for bulk cooling
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_O2_KOD_2"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "PEM_O2_KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "O2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_O2_Coalescer_1"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "PEM_Drain_Mixer"
        target_port: "PEM_O2_KOD_2"
        resource_type: "stream"

  - id: "PEM_O2_Coalescer_1"
    type: "Coalescer"
    params:
      component_id: "PEM_O2_Coalescer_1"
    connections:
      - source_port: "outlet"
        target_name: "PEM_O2_ElectricBoiler"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "PEM_Drain_Mixer"
        target_port: "PEM_O2_Coalescer_1"
        resource_type: "stream"


  - id: "PEM_O2_ElectricBoiler"
    type: "ElectricBoiler"
    params:
      max_power_kw: 25.0
      target_temp_c: 20.0 
      process_step: 230
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_O2_Valve"
        target_port: "inlet"
        resource_type: "stream"

  - id: "PEM_O2_Valve"
    type: "Valve"
    params:
      component_id: "PEM_O2_Valve"
      P_out_pa: 1500000.0 # 15 bar
      fluid: "O2"
    connections: []

  # =================================================================================
  # H2 PRODUCTION MIXING (Combines SOEC and PEM Trains)
  # =================================================================================

  - id: "H2_Production_Mixer"
    type: "Mixer"
    params:
      volume_m3: 5.0
      continuous_flow: true
      process_step: 400
    connections:
      - source_port: "outlet"
        target_name: "HP_Compressor_S1"
        target_port: "h2_in"
        resource_type: "gas"

  # =================================================================================
  # HIGH PRESSURE COMPRESSION TRAIN (40 bar → 500 bar)
  # Redistributed Pressure Ratios ~1.65x per stage
  # Limit: 135ºC
  # =================================================================================

  # --- Stage 1 (40.0 → 66.3 bar) ---
  - id: "HP_Compressor_S1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0 # Pro-rated for combined flow (400 SOEC + 120 PEM approx)
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 40.0
      outlet_pressure_bar: 66.3
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S1"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S2"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 2 (66.3 → 109.9 bar) ---
  - id: "HP_Compressor_S2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 66.3
      outlet_pressure_bar: 109.9
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S2"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S3"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 3 (109.9 → 182.1 bar) ---
  - id: "HP_Compressor_S3"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 109.9
      outlet_pressure_bar: 182.1
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S3"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S3"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S4"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 4 (182.1 → 301.8 bar) ---
  - id: "HP_Compressor_S4"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 182.1
      outlet_pressure_bar: 301.8
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S4"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S4"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S5"
        target_port: "h2_in"
        resource_type: "gas"

  # --- Stage 5 (301.8 → 500.0 bar) ---
  - id: "HP_Compressor_S5"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 301.8
      outlet_pressure_bar: 500.0
    connections:
      - source_port: "outlet"
        target_name: "HP_DryCooler_S5"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "HP_DryCooler_S5"
    type: "DryCooler"
    params: 
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "H2_Storage_Tank"
        target_port: "h2_in"
        resource_type: "gas"

  # =================================================================================
  # HYDROGEN STORAGE (500 bar)
  # =================================================================================

  - id: "H2_Storage_Tank"
    type: "Tank"
    params:
      n_tanks: 10
      capacity_kg: 1000.0  # 10000 kg total (10 ton)
      max_pressure_bar: 500.0
      temperature_k: 298.15
    connections: []
