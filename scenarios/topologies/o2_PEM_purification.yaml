# O2 Treatment Train Topology
# Based on Legacy PEM Simulator
# Flow: O2_Source → KOD_1 → DryCooler_1 → Chiller_1 (4°C) → KOD_2 → Coalescer_1 → Valve_1 (15 bar)

nodes:
  # === O2 Source (PEM cathode output with H2 crossover and moisture) ===
  # Mass flow: 1412.4 kg/h
  - id: "O2_Source"
    type: "ExternalOxygenSource"  # Now supported
    params:
      mass_flow_kg_h: 1412.4
      pressure_bar: 40.0
      temperature_c: 60.0
      o2_purity: 0.946
      h2_impurity: 0.00025
      h2o_impurity: 0.0535
    connections:
      - source_port: "o2_out"  # Corrected from h2_out
        target_name: "KOD_1"
        target_port: "gas_inlet"
        resource_type: "gas"

  # === Knock-Out Drum 1 (Initial water separation) ===
  - id: "KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 1.0
      delta_p_bar: 0.05
      gas_species: "O2"
    connections:
      - source_port: "gas_outlet"
        target_name: "DryCooler_1"
        target_port: "fluid_in"
        resource_type: "gas"

  # === Dry Cooler 1 (Passive air cooling) ===
  - id: "DryCooler_1"
    type: "DryCooler"
    params:
      component_id: "DryCooler_1"
    connections:
      - source_port: "fluid_out"
        target_name: "Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"

  # === Chiller 1 (Deep cooling to 4°C) ===
  - id: "Chiller_1"
    type: "Chiller"
    params:
      component_id: "Chiller_1"
      target_temp_k: 277.15  # 4°C
      cooling_capacity_kw: 200.0
      cop: 4.0
      pressure_drop_bar: 0.0
    connections:
      - source_port: "fluid_out"
        target_name: "KOD_2"
        target_port: "gas_inlet"
        resource_type: "stream"

  # === Knock-Out Drum 2 (Post-chiller water separation) ===
  - id: "KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 1.0
      delta_p_bar: 0.05
      gas_species: "O2"
    connections:
      - source_port: "gas_outlet"
        target_name: "Coalescer_1"
        target_port: "inlet"
        resource_type: "gas_mixture"

  # === Coalescer 1 (Mist elimination) ===
  - id: "Coalescer_1"
    type: "Coalescer"
    params:
      component_id: "Coalescer_1"
      gas_type: "O2"
    connections:
      - source_port: "outlet"
        target_name: "Valve_1"
        target_port: "inlet"
        resource_type: "gas"

  # === Throttling Valve (Expansion to 15 bar) ===
  - id: "Valve_1"
    type: "Valve"
    params:
      P_out_pa: 1500000.0  # 15 bar
      fluid: "O2"
    connections: []
