# SOEC Hydrogen Production Train Topology
# 
# Process Description (REORDERED to match legacy architecture):
# 1. Hot wet H2 from SOEC (152°C) enters Heat Recovery (Interchanger).
# 2. Cooled gas passes through staged cooling and separation (DryCooler -> Chiller -> KODs).
# 3. Dried H2 is COMPRESSED (5-Stage to 40 bar) BEFORE purification.
# 4. Compressed H2 is purified (Deoxo -> PSA) at high pressure.
# 5. Recovered water is collected, mixed with fresh makeup water, pressurized, and pre-heated.

nodes:
  # =================================================================================
  # CENTRALIZED COOLING UTILITY (Configurable via Topology)
  # =================================================================================
  - id: "cooling_manager"
    type: "CoolingManager"
    params:
      dc_total_area_m2: 15000.0       # Slightly smaller for ATR-less plant
      dc_air_flow_kg_s: 4000.0
      dc_u_value: 35.0
      glycol_inventory_kg: 40000.0
      tower_design_load_kw: 40000.0
      t_dry_bulb_c: 25.0
      t_wet_bulb_c: 18.0
      inertia_alpha: 0.3
      system_group: "Utilities"
      process_step: 0

  # =================================================================================
  # WATER SUPPLY CHAIN (Push Architecture with Feedback Control)
  # =================================================================================
  # Architecture: Source -> Purifier -> Tank -> Pumps -> Mixers
  # Tank sends control_signal to Source (Zone A/B/C based on fill level)
  # Mixers send demand_signal to Tank (PEM, SOEC channels)

  # 0.1 External Water Source (Municipal/Reservoir)
  - id: "Water_Source"
    type: "ExternalWaterSource"
    params:
      mode: "external_control"
      flow_rate_kg_h: 12000.0  # Max capacity
      pressure_bar: 5.0
      temperature_c: 25.0
      system_group: "Water_Supply"
      process_step: 1
    connections:
      - source_port: "water_out"
        target_name: "Water_Purifier"
        target_port: "raw_water_in"
        resource_type: "stream"

  # 0.2 Reverse Osmosis Water Purifier
  - id: "Water_Purifier"
    type: "WaterPurifier"
    params:
      max_flow_kg_h: 12000.0  # Rated @ 25°C
      recovery_ratio: 0.75
      system_group: "Water_Supply"
      process_step: 2
    connections:
      - source_port: "ultrapure_out"
        target_name: "UltraPure_Tank"
        target_port: "ultrapure_in"
        resource_type: "stream"

  # 0.3 Ultra-Pure Water Tank (Multi-Channel Distribution)
  - id: "UltraPure_Tank"
    type: "UltraPureWaterTank"
    params:
      capacity_kg: 20000.0
      nominal_production_kg_h: 10000.0
      initial_fill_fraction: 0.7
      system_group: "Water_Supply"
      process_step: 3
    connections:
      # Control signal to upstream source (feedback)
      - source_port: "control_signal"
        target_name: "Water_Source"
        target_port: "control_signal"
        resource_type: "signal"
      # Water distribution to loops (no ATR channel)
      - source_port: "water_out_SOEC"
        target_name: "SOEC_Makeup_Mixer"
        target_port: "makeup_water_in"
        resource_type: "stream"
      - source_port: "water_out_PEM"
        target_name: "PEM_Makeup_Mixer"
        target_port: "makeup_water_in"
        resource_type: "stream"

  # =================================================================================
  # MAIN GAS TRAIN: SOEC -> SEPARATION -> COMPRESSION -> PURIFICATION
  # =================================================================================

  # 1. SOEC Cluster
  # -------------------------------------------------------------------------
  # The h2_out port now outputs the combined Cathode Exhaust (Wet Hydrogen):
  # H2 (produced) + H2O (unreacted steam) + trace O2 (crossover)
  - id: "SOEC_Cluster"
    type: "SOEC"
    params:
      num_modules: 6
      max_power_nominal_mw: 2.4
      optimal_limit: 0.80
      steam_input_ratio_kg_per_kg_h2: 11.0 
      power_first_step_mw: 0.12
      ramp_step_mw: 0.24
      lifecycle: 43800  # 5 years lifecycle for degradation reset
      process_step: 10
    connections:
      - source_port: "h2_out"
        target_name: "SOEC_H2_Interchanger_1"
        target_port: "hot_in"
        resource_type: "stream"
      - source_port: "o2_out"
        target_name: "SOEC_O2_Interchanger_1"
        target_port: "hot_in"
        resource_type: "stream"

  # 2. Heat Recovery (Interchanger)
  - id: "SOEC_H2_Interchanger_1"
    type: "Interchanger"
    params:
      min_approach_temp_k: 10.0
      target_cold_out_temp_c: 95.0
      process_step: 20
    connections:
      - source_port: "hot_out"
        target_name: "SOEC_H2_DryCooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "cold_out"
        target_name: "SOEC_Interchanger_Drain_Combiner"
        target_port: "inlet_1"
        resource_type: "stream"


  # 3b. Dry Cooler (Post-Heat Recovery)
  - id: "SOEC_H2_DryCooler_1"
    type: "DryCooler"
    params:
      target_temp_c: 40.0  
      process_step: 30
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"

  # =================================================================================
  # SEPARATION STAGE (Before Compression)
  # =================================================================================

  - id: "SOEC_H2_KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.8
      delta_p_bar: 0.05
      process_step: 40
    connections:
      - source_port: "gas_outlet"
        target_name: "SOEC_H2_Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "SOEC_DRAIN_PUMP_1"
        target_port: "water_in"
        resource_type: "stream"

  - id: "SOEC_DRAIN_PUMP_1"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "SOEC_DRAIN_PUMP_1"
      capacity_kg_h: 2000.0
      target_pressure_pa: 100000.0
      process_step: 45
    connections:
      - source_port: "water_out"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_DRAIN_PUMP_1"
        resource_type: "stream"

  - id: "SOEC_H2_Chiller_1"
    type: "Chiller"
    params:
      cooling_capacity_kw: 500.0
      target_temp_k: 277.15 # 4°C
      process_step: 33  # Reordered step
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_KOD_2"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "SOEC_H2_KOD_2"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.6
      delta_p_bar: 0.05
      process_step: 60
    connections:
      - source_port: "gas_outlet"
        target_name: "SOEC_H2_Cyclone_1"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "SOEC_DRAIN_PUMP_2"
        target_port: "water_in"
        resource_type: "stream"

  - id: "SOEC_DRAIN_PUMP_2"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "SOEC_DRAIN_PUMP_2"
      capacity_kg_h: 2000.0
      target_pressure_pa: 100000.0
      process_step: 65
    connections:
      - source_port: "water_out"
        target_name: "SOEC_Drain_Mixer"
        target_port: "SOEC_DRAIN_PUMP_2"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_1"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0  # High efficiency separation of fine mist
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0   # Optimized for fine droplets
      process_step: 70
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Boiler"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Boiler"
    type: "ElectricBoiler"
    params:
      target_temp_c: 15.0
      max_power_kw: 100.0
      efficiency: 0.99
      k_friction: 0.0
      process_step: 80
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Compressor_S1"
        target_port: "h2_in"
        resource_type: "stream"



  # =================================================================================
  # COMPRESSION TRAIN (6-Stage, BEFORE Purification)
  # Redistributed Pressure Ratios ~2.0x per stage (Target ~42 bar)
  # =================================================================================

  - id: "SOEC_H2_Compressor_S1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 100
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_1"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      design_capacity_kw: 1800.0
      use_central_utility: false
      process_step: 101
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Compressor_S2"
        target_port: "h2_in"
        resource_type: "stream"
  
  - id: "SOEC_H2_Compressor_S2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 110
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_2"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      design_capacity_kw: 1800.0
      use_central_utility: false
      process_step: 111
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_2"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 112
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S3"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S3"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 120
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_3"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_3"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      design_capacity_kw: 1800.0
      use_central_utility: false
      process_step: 121
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_3"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_3"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 122
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S4"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S4"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 130
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_4"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_4"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      design_capacity_kw: 1800.0
      use_central_utility: false
      process_step: 131
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_4"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_4"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 132
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S5"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S5"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 200.0
      process_step: 140
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_5"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_5"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      design_capacity_kw: 1800.0
      use_central_utility: false
      process_step: 141
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_5"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_5"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 142
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Compressor_S6"
        target_port: "h2_in"
        resource_type: "stream"

  - id: "SOEC_H2_Compressor_S6"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 400.0
      max_temp_c: 135.0
      temperature_limited: true
      outlet_pressure_bar: 41.0
      process_step: 150
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Intercooler_6"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Intercooler_6"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
      process_step: 151
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Deoxo_1"
        target_port: "inlet"
        resource_type: "stream"



  # =================================================================================
  # PURIFICATION STAGE (After 6-Stage Compression, at 42 bar)
  # =================================================================================

  - id: "SOEC_H2_Deoxo_1"
    type: "DeoxoReactor"
    params:
      process_step: 200
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Chiller_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_Chiller_2"
    type: "Chiller"
    params:
      target_temp_k: 277.15 # 4°C heavy cooling for condensation
      cooling_capacity_kw: 300.0
      process_step: 210
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_Cyclone_6"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Cyclone_6"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      process_step: 215
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_Coalescer_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_H2_Coalescer_2"
    type: "Coalescer"
    params:
      d_shell: 0.3  # Post-Deoxo coalescer (high pressure, low liquid load)
      process_step: 220
    connections:
      - source_port: "outlet"
        target_name: "SOEC_H2_ElectricBoiler_PSA"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_H2_ElectricBoiler_PSA"
    type: "ElectricBoiler"
    params:
      max_power_kw: 50.0
      target_temp_c: 40.0 
      process_step: 230
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_H2_PSA_1"
        target_port: "gas_in"
        resource_type: "stream"

  - id: "SOEC_H2_PSA_1"
    type: "PSA Unit"
    params:
      purity_target: 0.99995
      process_step: 300
    connections:
      - source_port: "purified_gas_out"
        target_name: "H2_Production_Mixer"
        target_port: "inlet_1"
        resource_type: "gas"

  # =================================================================================
  # O2 PURIFICATION TRAIN (Anode Side)
  # Sequence: SOEC(o2_out) -> KOD1 -> DryCooler -> Chiller -> KOD2 -> Coalescer -> Vent
  # =================================================================================





  # === New O2 Compression Train (4 Stages) ===
  
  # Heat Recovery (O2 side)
  - id: "SOEC_O2_Interchanger_1"
    type: "Interchanger"
    params:
      min_approach_temp_k: 10.0
      target_cold_out_temp_c: 80.0  # Lower than H2 side
      process_step: 21
    connections:
      - source_port: "hot_out"
        target_name: "SOEC_O2_Drycooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "cold_out"
        target_name: "SOEC_Interchanger_Drain_Combiner"
        target_port: "inlet_2"
        resource_type: "stream"

  # Stage 1
  - id: "SOEC_O2_Drycooler_1"
    type: "DryCooler"
    params:
      component_id: "SOEC_O2_Drycooler_1"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_1"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_1"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_O2_Drycooler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  # Stage 2
  - id: "SOEC_O2_Drycooler_2"
    type: "DryCooler"
    params: 
      component_id: "SOEC_O2_Drycooler_2"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_2"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_O2_Drycooler_3"
        target_port: "fluid_in"
        resource_type: "stream"

  # Stage 3
  - id: "SOEC_O2_Drycooler_3"
    type: "DryCooler"
    params:
      component_id: "SOEC_O2_Drycooler_3"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_3"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_3"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_O2_Drycooler_4"
        target_port: "fluid_in"
        resource_type: "stream"

  # Stage 4
  - id: "SOEC_O2_Drycooler_4"
    type: "DryCooler"
    params:
      component_id: "SOEC_O2_Drycooler_4"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_O2_compressor_4"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_O2_compressor_4"
    type: "CompressorSingle"
    params:
      outlet_pressure_bar: 15.0
      max_temp_c: 135.0
      temperature_limited: true
      system_group: "SOEC_O2_Train"
      process_step: 33
    connections:
      - source_port: "outlet"
        target_name: "O2_Production_Mixer"
        target_port: "inlet_1"
        resource_type: "stream"



  # =================================================================================
  # WATER RECIRCULATION LOOP
  # =================================================================================

  - id: "SOEC_Drain_Mixer"
    type: "DrainRecorderMixer"
    params:
      source_ids: ["SOEC_DRAIN_PUMP_1", "SOEC_DRAIN_PUMP_2"]
    connections:
      - source_port: "outlet"
        target_name: "SOEC_Drain_Pump"
        target_port: "water_in"
        resource_type: "stream"
  
  - id: "SOEC_Drain_Pump"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "SOEC_Drain_Pump"
      capacity_kg_h: 3600.0
      target_pressure_pa: 100000.0  # 1 bar
    connections:
      - source_port: "water_out"
        target_name: "SOEC_Interchanger_Splitter"
        target_port: "inlet"
        resource_type: "stream"

  # Split drain flow: 62.9% to H2 Interchanger, 37.1% to O2 Interchanger
  - id: "SOEC_Interchanger_Splitter"
    type: "StreamSplitter"
    params:
      split_ratio: 0.629  # Fraction to Outlet 1 (H2 Interchanger cold side)
    connections:
      - source_port: "outlet_1"
        target_name: "SOEC_H2_Interchanger_1"
        target_port: "cold_in"
        resource_type: "stream"
      - source_port: "outlet_2"
        target_name: "SOEC_O2_Interchanger_1"
        target_port: "cold_in"
        resource_type: "stream"

  # Recombine interchanger cold outlets before makeup mixer
  - id: "SOEC_Interchanger_Drain_Combiner"
    type: "Mixer"
    params:
      volume_m3: 0.5
      continuous_flow: true
    connections:
      - source_port: "outlet"
        target_name: "SOEC_Makeup_Mixer"
        target_port: "drain_in"
        resource_type: "stream"
  
  - id: "SOEC_Makeup_Mixer"
    type: "SignalMakeupMixer"
    params:
      target_flow_kg_h: 3600.0  # SOEC theoretical demand
      makeup_temp_c: 25.0
      system_group: "SOEC_Water_Loop"
    connections:
      - source_port: "mixture_out"
        target_name: "SOEC_Water_Splitter"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "demand_signal"
        target_name: "UltraPure_Tank"
        target_port: "demand_SOEC"
        resource_type: "signal"

  # Split: 91.54% to Steam Boiler, 8.46% to Bypass (Attemperator)
  - id: "SOEC_Water_Splitter"
    type: "StreamSplitter"
    params:
      split_ratio: 0.9154  # Fraction to Outlet 1 (Direct to Boiler)
    connections:
      - source_port: "outlet_1"
        target_name: "SOEC_Steam_Boiler"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "outlet_2"
        target_name: "SOEC_Feed_Pump"
        target_port: "water_in"
        resource_type: "stream"

  # --- LOOP MAIN: STEAM COMPRESSION (91.54%) ---
  # Note: ATR Syngas Cooler heat recovery removed - water goes directly to boiler

  - id: "SOEC_Steam_Boiler"
    type: "ElectricBoiler"
    params:
      max_power_kw: 3000.0
      target_temp_c: 105.0 # Ensure 100% Steam at ~1 bar
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_Steam_Compressor_1"
        target_port: "inlet"
        resource_type: "stream"

  - id: "SOEC_Steam_Compressor_1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 4000.0
      inlet_pressure_bar: 1.0
      outlet_pressure_bar: 2.3
      max_temp_c: 270.0
    connections:
      - source_port: "outlet"
        target_name: "SOEC_Steam_Drycooler"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "SOEC_Steam_Drycooler"
    type: "DryCooler"
    params:
      target_temp_c: 140.0
      system_group: "SOEC_Steam_Loop"
    connections:
      - source_port: "fluid_out"
        target_name: "SOEC_Steam_Compressor_2"
        target_port: "inlet"
        resource_type: "stream"
      
  - id: "SOEC_Steam_Compressor_2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 4000.0
      inlet_pressure_bar: 2.3
      outlet_pressure_bar: 5.0
      max_temp_c: 270.0
    connections:
      - source_port: "outlet"
        target_name: "SOEC_Feed_Attemperator"
        target_port: "inlet_1"
        resource_type: "stream"

  # --- BYPASS LOOP: ATTEMPERATION WATER (8.46%) ---

  - id: "SOEC_Feed_Pump"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "SOEC_Feed_Pump"
      capacity_kg_h: 3600.0
      target_pressure_pa: 500000.0 # 5 bar
    connections:
      - source_port: "water_out"
        target_name: "SOEC_Feed_Attemperator"  # Inject into mixer
        target_port: "inlet_2"
        resource_type: "stream"

  # --- RECOMBINATION & FEED ---

  - id: "SOEC_Feed_Attemperator"
    type: "Attemperator"
    params:
      target_temp_k: 430.05  # 156.9°C (5°C superheat at 5.0 bar)
      min_superheat_delta_k: 5.0
      pipe_diameter_m: 0.1541  # 6" Schedule 40
      volume_m3: 0.050  # Adj. to 0.035m3 for <0.1s residence time
      pressure_drop_bar: 0.5  # Venturi nozzle pressure drop
      heat_loss_kw: 0.0
      max_water_flow_kg_h: 500.0
    connections:
      - source_port: "steam_out"
        target_name: "SOEC_Cluster"
        target_port: "steam_in"
        resource_type: "stream"



  # =================================================================================
  # PEM WATER RECIRCULATION LOOP
  # =================================================================================

  - id: "PEM_H2_Drain_Mixer"
    type: "DrainRecorderMixer"
    params:
      source_ids: ["PEM_H2_KOD_1", "PEM_H2_Cyclone_2", "PEM_H2_Cyclone_3"]
    connections:
      - source_port: "outlet"
        target_name: "PEM_Water_Return_Valve_1"
        target_port: "inlet"
        resource_type: "stream"

  - id: "PEM_O2_Drain_Mixer"
    type: "DrainRecorderMixer"
    params:
      source_ids: ["PEM_O2_KOD_1", "PEM_O2_Cyclone_2"]
    connections:
      - source_port: "outlet"
        target_name: "PEM_Water_Return_Valve_2"
        target_port: "inlet"
        resource_type: "stream"

  # Path 1: H2 Side Degassing
  - id: "PEM_Water_Return_Valve_1"
    type: "Valve"
    params:
      component_id: "PEM_Water_Return_Valve_1"
      P_out_pa: 400000.0 # 4 bar
      fluid: "H2O"
    connections: 
      - source_port: "outlet"
        target_name: "PEM_Degasser_1"
        target_port: "mixture_in"
        resource_type: "stream"

  - id: "PEM_Degasser_1"
    type: "SeparationTank"
    params:
      volume_m3: 2.0
      efficiency: 1.0
    connections:
      - source_port: "liquid_out"
        target_name: "PEM_Drains_Combiner"
        target_port: "inlet_1"
        resource_type: "stream"
      # Gas out is vented (open port)

  # Path 2: O2 Side Degassing
  - id: "PEM_Water_Return_Valve_2"
    type: "Valve"
    params:
      component_id: "PEM_Water_Return_Valve_2"
      P_out_pa: 400000.0 # 4 bar
      fluid: "H2O"
    connections: 
      - source_port: "outlet"
        target_name: "PEM_Degasser_2"
        target_port: "mixture_in"
        resource_type: "stream"

  - id: "PEM_Degasser_2"
    type: "SeparationTank"
    params:
      volume_m3: 1.0
      efficiency: 1.0
    connections:
      - source_port: "liquid_out"
        target_name: "PEM_Drains_Combiner"
        target_port: "inlet_2"
        resource_type: "stream"
      # Gas out is vented (open port)

  # Common Return
  - id: "PEM_Drains_Combiner"
    type: "Mixer"
    params:
      volume_m3: 0.5
      continuous_flow: true
    connections:
      - source_port: "outlet"
        target_name: "PEM_Makeup_Mixer"
        target_port: "drain_in"
        resource_type: "stream"

  - id: "PEM_Makeup_Mixer"
    type: "SignalMakeupMixer"
    params:
      target_flow_kg_h: 4000.0  # PEM theoretical demand (~5 MW)
      makeup_temp_c: 20.0
      system_group: "PEM_Water_Loop"
    connections:
      - source_port: "mixture_out"
        target_name: "PEM_Water_Pump"
        target_port: "water_in"
        resource_type: "stream"
      - source_port: "demand_signal"
        target_name: "UltraPure_Tank"
        target_port: "demand_PEM"
        resource_type: "signal"

  - id: "PEM_Water_Pump"
    type: "WaterPumpThermodynamic"
    params:
      pump_id: "PEM_Water_Pump"
      capacity_kg_h: 4000.0
      target_pressure_pa: 4000000.0  # 40 bar (PEM operating pressure)
    connections:
      - source_port: "water_out"
        target_name: "PEM_Electrolyzer"
        target_port: "water_in"
        resource_type: "stream"

  # =================================================================================
  # PEM HYDROGEN PRODUCTION TRAIN (Secondary Source)
  # =================================================================================

  - id: "PEM_Electrolyzer"
    type: "PEM"
    params:
      max_power_mw: 5.0
      use_polynomials: True
      water_excess_factor: 0.02 
      out_pressure_pa: 4000000.0 # 40 bar
      lifecycle: 43800  # 5 years lifecycle for degradation reset 
    connections:
      - source_port: "h2_out"
        target_name: "PEM_H2_KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"
      - source_port: "oxygen_out"
        target_name: "PEM_O2_KOD_1"
        target_port: "gas_inlet"
        resource_type: "stream"

  - id: "PEM_H2_KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "H2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_H2_DryCooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "PEM_H2_Drain_Mixer"
        target_port: "PEM_H2_KOD_1"
        resource_type: "stream"

  - id: "PEM_H2_DryCooler_1"
    type: "DryCooler"
    params: {}
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_H2_Chiller_1"
    type: "Chiller"
    params:
      target_temp_k: 277.15
      cooling_capacity_kw: 500.0 # Upsized for 5x liquid water
      cop: 4.0
      pressure_drop_bar: 0.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_Cyclone_2"
        target_port: "inlet"
        resource_type: "gas"

  - id: "PEM_H2_Cyclone_2"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      gas_species: "H2"
    connections:
      - source_port: "outlet"
        target_name: "PEM_H2_Coalescer_1"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "PEM_H2_Drain_Mixer"
        target_port: "PEM_H2_Cyclone_2"
        resource_type: "stream"

  - id: "PEM_H2_Coalescer_1"
    type: "Coalescer"
    params:
      gas_type: "H2"
    connections:
      - source_port: "outlet"
        target_name: "PEM_H2_ElectricBoiler_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_H2_ElectricBoiler_1"
    type: "ElectricBoiler"
    params: 
      max_power_kw: 25.0
      target_temp_c: 40.0
      efficiency: 0.98
    connections:
      - source_port: "fluid_out"  
        target_name: "PEM_H2_Deoxo_1"
        target_port: "inlet"
        resource_type: "gas"

  - id: "PEM_H2_Deoxo_1"
    type: "DeoxoReactor"
    params: {}
    connections:
      - source_port: "outlet"
        target_name: "PEM_H2_Chiller_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_H2_Chiller_2"
    type: "Chiller"
    params:
      target_temp_k: 277.15
      cooling_capacity_kw: 500.0 # Upsized for 5x liquid water
      cop: 4.0
      pressure_drop_bar: 0.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_Cyclone_3"
        target_port: "inlet"
        resource_type: "gas"
    
  - id: "PEM_H2_Cyclone_3"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 22.0
      gas_species: "H2"
    connections:
      - source_port: "outlet"
        target_name: "PEM_H2_Coalescer_2"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "PEM_H2_Drain_Mixer"
        target_port: "PEM_H2_Cyclone_3"
        resource_type: "stream"

  - id: "PEM_H2_Coalescer_2"
    type: "Coalescer"
    params:
      component_id: "PEM_H2_Coalescer_2"
    connections:
      - source_port: "outlet"
        target_name: "PEM_H2_ElectricBoiler_2"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_H2_ElectricBoiler_2"
    type: "ElectricBoiler"
    params: 
      max_power_kw: 25.0
      target_temp_c: 30.0
      efficiency: 0.98
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_H2_PSA_1"
        target_port: "gas_in"
        resource_type: "stream"

  - id: "PEM_H2_PSA_1"
    type: "PSA Unit"
    params:
      purity_target: 0.99995
      recovery_rate: 0.90
      power_consumption_kw: 10.0
    connections: 
      - source_port: "purified_gas_out"
        target_name: "H2_Production_Mixer"
        target_port: "inlet_2"
        resource_type: "gas"

  # =================================================================================
  # PEM O2 PURIFICATION TRAIN
  # Sequence: PEM(o2_out) -> KOD1 -> DryCooler -> Chiller -> KOD2 -> Coalescer -> Valve -> Vent
  # =================================================================================

  - id: "PEM_O2_KOD_1"
    type: "KnockOutDrum"
    params:
      diameter_m: 0.5
      delta_p_bar: 0.05
      gas_species: "O2"
    connections:
      - source_port: "gas_outlet"
        target_name: "PEM_O2_Drycooler_1"
        target_port: "fluid_in"
        resource_type: "stream"
      - source_port: "liquid_drain"
        target_name: "PEM_O2_Drain_Mixer"
        target_port: "PEM_O2_KOD_1"
        resource_type: "stream"

  - id: "PEM_O2_Drycooler_1"
    type: "DryCooler"
    params:
      component_id: "PEM_O2_Drycooler_1"
      target_temp_c: 30.0
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_O2_Chiller_1"
        target_port: "fluid_in"
        resource_type: "stream"

  - id: "PEM_O2_Chiller_1"
    type: "Chiller"
    params:
      component_id: "PEM_O2_Chiller_1"
      target_temp_k: 277.15 # 4°C
      cooling_capacity_kw: 8000.0 # Upsized for bulk cooling
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_O2_Cyclone_2"
        target_port: "inlet"
        resource_type: "stream"

  - id: "PEM_O2_Cyclone_2"
    type: "HydrogenMultiCyclone"
    params:
      element_diameter_mm: 50.0
      vane_angle_deg: 45.0
      target_velocity_ms: 20.0
      gas_species: "O2"
    connections:
      - source_port: "outlet"
        target_name: "PEM_O2_Coalescer_1"
        target_port: "inlet"
        resource_type: "stream"
      - source_port: "drain"
        target_name: "PEM_O2_Drain_Mixer"
        target_port: "PEM_O2_Cyclone_2"
        resource_type: "stream"

  - id: "PEM_O2_Coalescer_1"
    type: "Coalescer"
    params:
      component_id: "PEM_O2_Coalescer_1"
    connections:
      - source_port: "outlet"
        target_name: "PEM_O2_ElectricBoiler"
        target_port: "fluid_in"
        resource_type: "stream"


  - id: "PEM_O2_ElectricBoiler"
    type: "ElectricBoiler"
    params:
      max_power_kw: 25.0
      target_temp_c: 20.0 
      process_step: 230
    connections:
      - source_port: "fluid_out"
        target_name: "PEM_O2_Valve"
        target_port: "inlet"
        resource_type: "stream"

  - id: "PEM_O2_Valve"
    type: "Valve"
    params:
      component_id: "PEM_O2_Valve"
      P_out_pa: 1500000.0 # 15 bar
      fluid: "O2"
      system_group: "PEM_O2_Train"
      process_step: 40
    connections:
      - source_port: "outlet"
        target_name: "O2_Production_Mixer"
        target_port: "inlet_2"
        resource_type: "stream"

  # =================================================================================
  # O2 COMMON HEADER (SOEC + PEM) - ATR REMOVED
  # O2 is now vented or available for future alternative use
  # =================================================================================

  - id: "O2_Production_Mixer"
    type: "Mixer"
    params:
      volume_m3: 2.0
      continuous_flow: true
      enable_phase_equilibrium: false
      system_group: "O2_Header"
      process_step: 41
    connections: []  # O2 ends here - ATR no longer consumes O2


  # =================================================================================
  # H2 PRODUCTION MIXING (Combines SOEC and PEM Trains)
  # =================================================================================

  - id: "H2_Production_Mixer"
    type: "Mixer"
    params:
      volume_m3: 5.0
      continuous_flow: true
      process_step: 400
    connections:
      - source_port: "outlet"
        target_name: "H2_Production_Cooler"
        target_port: "fluid_in"
        resource_type: "gas"

  - id: "H2_Production_Cooler"
    type: "DryCooler"
    params:
      target_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "LP_Compressor_S1"
        target_port: "h2_in"
        resource_type: "gas"

  # =================================================================================
  # HIGH PRESSURE COMPRESSION TRAIN (40 bar → 500 bar)
  # Redistributed Pressure Ratios ~1.65x per stage
  # Limit: 135ºC
  # =================================================================================

  # --- Stage 1 (40.0 → 70.0 bar) ---
  - id: "LP_Compressor_S1"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 520.0 # Pro-rated for combined flow (400 SOEC + 120 PEM approx)
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 40.0
      outlet_pressure_bar: 70.0
    connections:
      - source_port: "outlet"
        target_name: "LP_Intercooler_1"
        target_port: "fluid_in"
        resource_type: "gas"

  - id: "LP_Intercooler_1"
    type: "DryCooler"
    params:
      design_capacity_kw: 500.0
      target_out_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "LP_Storage_Tank"
        target_port: "h2_in"
        resource_type: "gas"

  # =================================================================================
  # HYDROGEN STORAGE (70 bar)
  # =================================================================================

  - id: "LP_Storage_Tank"
    type: "DetailedTank"
    params:
      n_tanks: 30
      volume_per_tank_m3: 107.37 # From HP spec, assumed consistent
      max_pressure_bar: 70.0
      initial_pressure_bar: 1.0
      min_discharge_pressure_bar: 30.0
      ambient_temp_k: 298.15
    connections:
      - source_port: "h2_out"
        target_name: "HP_Compressor_S2"
        target_port: "inlet"
        resource_type: "gas"

  # =================================================================================
  # HP COMPRESSION TRAIN (500 bar)
  # =================================================================================

  - id: "HP_Compressor_S2"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 720.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 30.0
      outlet_pressure_bar: 60.0 # Balanced Stage 1/4
    connections:
      - source_port: "outlet"
        target_name: "HP_Intercooler_2"
        target_port: "fluid_in"
        resource_type: "gas"

  - id: "HP_Intercooler_2"
    type: "DryCooler"
    params:
      design_capacity_kw: 500.0
      target_out_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S3"
        target_port: "inlet"
        resource_type: "gas"

  - id: "HP_Compressor_S3"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 720.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 60.0 
      outlet_pressure_bar: 125.0 # Balanced Stage 2/4
    connections:
      - source_port: "outlet"
        target_name: "HP_Intercooler_3"
        target_port: "fluid_in"
        resource_type: "gas"

  - id: "HP_Intercooler_3"
    type: "DryCooler"
    params:
      design_capacity_kw: 500.0
      target_out_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S4"
        target_port: "inlet"
        resource_type: "gas"

  - id: "HP_Compressor_S4"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 720.0
      max_temp_c: 135.0
      temperature_limited: true
      inlet_pressure_bar: 125.0 
      outlet_pressure_bar: 250.0 # Balanced Stage 3/4
    connections:
      - source_port: "outlet"
        target_name: "HP_Intercooler_4"
        target_port: "fluid_in"
        resource_type: "gas"

  - id: "HP_Intercooler_4"
    type: "DryCooler"
    params:
      design_capacity_kw: 500.0 # Revert to reasonable sizing
      target_out_temp_c: 40.0
    connections:
      - source_port: "fluid_out"
        target_name: "HP_Compressor_S5"
        target_port: "inlet"
        resource_type: "gas"
  
  - id: "HP_Compressor_S5"
    type: "CompressorSingle"
    params:
      max_flow_kg_h: 720.0
      max_temp_c: 135.0 # Lower limit for final stage
      temperature_limited: true
      inlet_pressure_bar: 250.0 
      outlet_pressure_bar: 500.0 # Final Stage 4/4
    connections:
      - source_port: "outlet"
        target_name: "Truck_Station_1"
        target_port: "h2_in"
        resource_type: "gas"


  # =================================================================================
  # TRUCK DISCHARGE STATION
  # Event-driven with isentropic compression energy calculation
  # =================================================================================

  - id: "Truck_Station_1"
    type: "DischargeStation"
    params:
      station_id: 1
      n_stations: 14  # Simulating 14 identical truck bays
      truck_capacity_kg: 280.0    # Reference: 280kg
      delivery_pressure_bar: 500.0
      max_fill_rate_kg_min: 1.5  # Reference: 90 kg/h
      min_fill_rate_kg_min: 0.583  # Simulation of lower demand/night shift
      h_in_day_max: 16.0        
      valves_close_time_min: 5.0  # Time to close valves
      arrival_probability: 0.3    # Ignored when h_in_day_max is set
      isen_efficiency: 0.65       # Reference: 0.65
      mech_efficiency: 0.90       # Reference: 0.90
      cooldown_minutes: 187.0     # Reference: 3 hours
    connections:
      # Feedback loop: Demand Signal flows back to Tank
      - source_port: "demand_signal"
        target_name: "LP_Storage_Tank"
        target_port: "demand_signal"
        resource_type: "signal"
